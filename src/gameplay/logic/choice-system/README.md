# üéØ Choice System Documentation

‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô Finix Game

## üìã **Overview**

Choice System ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ô‡πÄ‡∏Å‡∏° ‡πÄ‡∏ä‡πà‡∏ô:

- ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å effect ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î
- ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå
- ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
- ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô
- ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ

## ‚ú® **Features**

### ‚úÖ **1. Choice Validation System**
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö requirements (‡πÄ‡∏á‡∏¥‡∏ô, ‡∏™‡∏Å‡∏¥‡∏•, ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û)
- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô

### ‚úÖ **2. Input Queue Management**  
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 choices)
- ‡∏£‡∏∞‡∏ö‡∏ö priority ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

### ‚úÖ **3. Timeout Handling**
- ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à
- ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
- ‡πÉ‡∏ä‡πâ default choice ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ)

### ‚úÖ **4. Choice Broadcasting**
- ‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö real-time ‡∏ú‡πà‡∏≤‡∏ô WebSocket
- ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à
- ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏°

## üèóÔ∏è **Architecture**

```
üìÅ choice-system/
‚îú‚îÄ‚îÄ üß† choice-system.logic.ts          - Core business logic
‚îú‚îÄ‚îÄ üì° choice-broadcasting.service.ts  - WebSocket broadcasting  
‚îú‚îÄ‚îÄ üì¶ choice-system.module.ts         - NestJS module
‚îú‚îÄ‚îÄ üîß choice-system.interface.ts      - TypeScript interfaces
‚îú‚îÄ‚îÄ üì§ index.ts                        - Exports
‚îî‚îÄ‚îÄ üìñ README.md                       - Documentation
```

## üöÄ **Quick Start**

### **1. Import Module**
```typescript
// ‡πÉ‡∏ô gameplay.module.ts
import { ChoiceSystemModule } from './logic/choice-system';

@Module({
  imports: [ChoiceSystemModule],
  // ...
})
export class GameplayModule {}
```

### **2. Inject Services**
```typescript
// ‡πÉ‡∏ô gameplay.service.ts
import { ChoiceSystemLogic, ChoiceType } from './logic/choice-system';

@Injectable()
export class GameplayService {
  constructor(
    private readonly choiceSystem: ChoiceSystemLogic,
  ) {}
}
```

### **3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Choice Session**
```typescript
const choice = await this.choiceSystem.createChoiceSession(
  sessionId,
  playerInSessionId,
  ChoiceType.CARD_EFFECT,
  'Choose Card Effect',
  'Select one option:',
  [
    {
      id: 'option1',
      label: 'Get $500',
      value: { cash: 500 },
      isDefault: true
    },
    {
      id: 'option2', 
      label: 'Draw another card',
      value: { drawCard: true }
    }
  ],
  30 // 30 seconds timeout
);
```

### **4. ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö**
```typescript
const result = await this.choiceSystem.submitChoice(
  choiceSessionId,
  'option1',
  playerInSessionId
);
```

## üîß **API Reference**

### **ChoiceSystemLogic**

#### `createChoiceSession()`
```typescript
async createChoiceSession(
  sessionId: number,
  playerInSessionId: number,
  choiceType: ChoiceType,
  title: string,
  description: string,
  options: ChoiceOption[],
  timeoutSeconds?: number,
  metadata?: any
): Promise<ChoiceSession>
```

#### `submitChoice()`
```typescript
async submitChoice(
  choiceSessionId: string,
  selectedOptionId: string,
  playerInSessionId: number
): Promise<ChoiceResult>
```

#### `cancelChoice()`
```typescript
async cancelChoice(
  choiceSessionId: string,
  reason?: string
): Promise<void>
```

#### `getActiveChoices()`
```typescript
getActiveChoices(playerInSessionId: number): ChoiceSession[]
```

### **ChoiceTypes**
```typescript
enum ChoiceType {
  CARD_EFFECT = 'card_effect',
  ASSET_PURCHASE = 'asset_purchase', 
  INVESTMENT = 'investment',
  CAREER_SELECTION = 'career_selection',
  GOAL_SELECTION = 'goal_selection',
  MARKET_ACTION = 'market_action',
  CHARITY = 'charity',
  LIFE_EVENT = 'life_event',
  BOARD_SPACE = 'board_space'
}
```

## üåê **WebSocket Events**

### **Server ‚Üí Client**
```typescript
// ‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
'choice_presented': ChoiceSession

// ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô timeout  
'choice_timeout_warning': { 
  choiceSessionId: string;
  secondsLeft: number;
}

// ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à
'choice_processed': ChoiceResult

// ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
'choice_cancelled': { 
  choiceSessionId: string;
  reason: string;
}
```

### **Client ‚Üí Server**
```typescript
// ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
'submit_choice': { 
  choiceSessionId: string;
  selectedOptionId: string;
}

// ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
'cancel_choice': { 
  choiceSessionId: string;
}
```

## ‚öôÔ∏è **Configuration**

```typescript
interface ChoiceSystemConfig {
  defaultTimeoutSeconds: number;      // 30 - ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  maxConcurrentChoices: number;       // 3 - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
  retryAttempts: number;              // 3 - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ã‡πâ‡∏≥
  warningThresholdSeconds: number;    // 10 - ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
  enableAutoDefault: boolean;         // true - ‡πÉ‡∏ä‡πâ default ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  enableChoiceHistory: boolean;       // true - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
}
```

## üß™ **Testing**

### **Unit Tests**
```bash
npm test choice-system.logic.spec.ts
npm test choice-broadcasting.service.spec.ts
```

### **Integration Tests**
```bash
npm test choice-system.integration.spec.ts
```

### **Manual Testing**
```typescript
// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket
const success = await choiceBroadcastingService.testConnection(sessionId);

// ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏∞‡∏ö‡∏ö
const stats = choiceSystemLogic.getChoiceSystemStats();
console.log(stats);
```

## üîå **Integration Guide**

### **1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Card System**
```typescript
// ‡πÉ‡∏ô effect.card.logic.ts
async processChoiceEffect(playerId: number, effectData: any) {
  return await this.choiceSystem.createChoiceSession(
    sessionId,
    playerId,
    ChoiceType.CARD_EFFECT,
    effectData.title,
    effectData.description,
    effectData.choices
  );
}
```

### **2. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö WebSocket Gateway**
```typescript
// ‡πÉ‡∏ô gameplay.gateway.ts
constructor(
  private readonly choiceBroadcasting: ChoiceBroadcastingService,
) {
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gateway
  this.choiceBroadcasting.setWebSocketGateway(this);
}

@SubscribeMessage('submit_choice')
async handleSubmitChoice(client: Socket, data: any) {
  // Process choice submission
}
```

### **3. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Movement System**  
```typescript
// ‡πÉ‡∏ô movement.logic.ts
if (spaceData.requiresPlayerChoice) {
  return await this.choiceSystem.createChoiceSession(
    sessionId,
    playerInSessionId,
    ChoiceType.BOARD_SPACE,
    spaceData.title,
    spaceData.description,
    spaceData.choiceOptions
  );
}
```

## üêõ **Debugging**

### **Console Logs**
```typescript
// ‡πÄ‡∏õ‡∏¥‡∏î debug logs
private readonly logger = new Logger(ChoiceSystemLogic.name);

// ‡∏î‡∏π logs
[ChoiceSystemLogic] üéØ Choice System Logic initialized
[ChoiceSystemLogic] ‚úÖ Choice session created: choice_1234...
[ChoiceSystemLogic] ‚ö†Ô∏è Timeout warning: choice_1234...
[ChoiceSystemLogic] ‚úÖ Choice processed: choice_1234...
```

### **‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏∞‡∏ö‡∏ö**
```typescript
const stats = choiceSystemLogic.getChoiceSystemStats();
// {
//   totalActiveChoices: 2,
//   playersWithChoices: 1, 
//   config: { ... }
// }
```

### **Common Issues**
1. **WebSocket ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠** - ‡πÄ‡∏ä‡πá‡∏Ñ `setWebSocketGateway()`
2. **Choice ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤** - ‡πÄ‡∏ä‡πá‡∏Ñ timeout configuration
3. **Validation ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß** - ‡πÄ‡∏ä‡πá‡∏Ñ requirements ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô

## üìà **Performance**

- ‡πÉ‡∏ä‡πâ Memory ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1-2MB ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 100 active choices
- Timeout check ‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ  
- Broadcasting ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 100ms
- Database query ‡∏õ‡∏Å‡∏ï‡∏¥ 10-50ms

## üîÆ **Future Enhancements**

- [ ] AI-assisted choice recommendations
- [ ] Advanced analytics ‡πÅ‡∏•‡∏∞ metrics
- [ ] A/B testing ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö choice options
- [ ] Multi-language support
- [ ] Voice commands integration

---

## üìû **Support**

‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤:
1. ‡πÄ‡∏ä‡πá‡∏Ñ console logs
2. ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢ `getChoiceSystemStats()`
3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket ‡∏î‡πâ‡∏ß‡∏¢ `testConnection()`
4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö database connection

**Happy Coding! üöÄ**